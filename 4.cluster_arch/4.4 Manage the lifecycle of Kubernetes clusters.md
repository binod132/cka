# Manage the lifecycle of Kubernetes clusters
### Things to conver
## 4.4.1 Add a new worker node to the cluster
    Killercoda --> https://killercoda.com/killer-shell-cka/scenario/cluster-node-join
    Doc --> https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/adding-linux-nodes/

#### Check on worker node
    kubeadm version
    kubelet status

#### Get Join command
    sudo kubeadm token create --print-join-command

## 4.4.2 Backup etcd snapshot to /opt/etcd-backup.db
```sh
ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot save /opt/etcd-snapshot.db
##### save console log
ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key snapshot save /opt/cluster_backup.db 2>&1 | tee /opt/backup.txt
```
## 4.4.3 Restore cluster from etcd backup snapshot
Killercoda --> https://killercoda.com/sachin/course/CKA/etcd-restore
## After etcdctl version 3.5 (i.e in 3.6) etcdctl no longer works snapshot restore
### Download etcd and use etcdutl
        wget https://github.com/etcd-io/etcd/releases/download/v3.6.7/etcd-v3.6.7-linux-amd64.tar.gz
        tar -xvf etcd-v3.6.7-linux-amd64.tar.gz
        cd etcd-v3.6.7-linux-amd64/
        mv etcdutl /usr/bin/
#### take backup as above
#### Restore
etcdutl --data-dir /root/default.etcd snapshot restore /opt/cluster_backup.db 2>&1 | tee /root/restore.txt

    
## 4.4.4 Upgrade the cluster from 1.34.x to 1.34.y
    Doc --> https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/
    Killercoda--> https://killercoda.com/killer-shell-cka/scenario/cluster-upgrade

#### Upgrade from 1.3x.x to 1.3x.y (example 1.34.1 to 1.34.5) 
## Control Plane
#### see possible versions
    kubeadm upgrade plan

#### show available versions
    apt-cache show kubeadm

#### can be different for you
    apt-get install kubeadm=1.34.3-1.1

#### could be a different version for you, it can also take a bit to finish!
    kubeadm upgrade apply v1.34.3

    apt-get install kubectl=1.34.3-1.1 kubelet=1.34.3-1.1

    service kubelet restart

## Worker node
    # can be a different version for you
    apt-get install kubeadm=1.34.3-1.1
    kubeadm upgrade node

    apt-get install kubelet=1.34.3-1.1
    
    service kubelet restart